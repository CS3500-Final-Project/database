<!DOCTYPE html>
<html>
<head>
  <title>Image~In</title>
  <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <link rel="stylesheet" type="text/css" href="/stylesheets/main.css" />
  <nav class="navbar navbar-default navbar-static-top navbar-inverse">
    <div class="container">
      <ul class="nav navbar-nav">
        <li>
          <a href="/"><span class="glyphicon glyphicon-home"></span> Home</a>
        </li>

        <li>
          <a href="/db"><span class="glyphicon glyphicon-hdd"></span>Raw Data</a>
        </li>
        <li>
          <a href="/upload.html"><span class="glyphicon glyphicon-cloud-upload"></span>Upload</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="navbar-right">
          <a href="#"><span class="glyphicon glyphicon-user"></span>Account</a>
        </li>
      </ul>
    </div>
  </nav>
</head>

<body>

  <div class="jumbotron text-center">
    <div class="container">
      <a href="/" class="lang-logo">
        <img src="/images/lang-logo.png">
      </a>
      <h1>~Image In~</h1>
      <p>Try An Unsigned Upload</p>
    </div>
  </div>
  <div class="container">
    <h2>We're gonna need a bigger jumbotron...</h2>
    <a href="#" id="upload_widget_opener">Upload multiple images</a>

    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <!--server com request func from josh -->
  <script>
      function postStuffToServer(
         payload
       ) {
         let promise = new Promise(
           function(
             resolve,
             reject
           ) {
             var request = new XMLHttpRequest();

             request.open(
               "POST",
               './upload-image/'
             );

             request.setRequestHeader(
               'Content-Type',
               'application/json'
             );

             request.onload = function() {
               let status = this.status;

               if (
                 status >= 200
                 && status < 300
               ) {
                 resolve(
                   this.response
                 );
               }
               else {
                 reject(
                   this.statusText
                 );
               }
             }; // onload callback

             // not sure if stringification needed.
             // try other method first and switch
             // to this one if there are issues
             // sending an object

             let requestBody = JSON.stringify(
               payload
             );

             request.send(
               requestBody
             );

           } // executor
         ); // promise

         return promise;
     } // postStuffToServer
  </script>
    <script type="text/javascript">
    var myUploadWidget;
    document.getElementById("upload_widget_opener")
    .addEventListener(
      "click",
      function() {
        myUploadWidget = cloudinary.openUploadWidget(
          {
            cloudName: 'hws6kskjw',
            uploadPreset: 'rywvoxo2'
          },
          ( error, result ) => {        }, false
        );
      }
    ); // addEventListener

      cloudinary.applyUploadWidget('#upload_widget_opener',{
        cloudName: 'hws6kskjw', uploadPreset: 'rywvoxo2',
        cropping: true, folder: 'user_images' }, (error, result) => {
          //console.log( JSON.stringify( error ) );
          console.log( JSON.stringify( result ) );
          if (result && result.event === "success") {
            //console.log('Did you get that thing i sent ya?');
            //console.log( JSON.stringify( result => url ) );
            //try making server request
            postStuffToServer(
              result
            )
            .then(
              ( response ) => {
                // response might be text (a JSON string)
                // or it could be an object...
                // I was getting JSON strings even with
                // the headers set up to return JSON
                console.log( 'received response from server' );

                console.log(
                 response
                );
              } // response callback
            );
        }
           });
      </script>
  </div>

</body>
</html>
